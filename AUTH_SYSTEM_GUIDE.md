# راهنمای سیستم احراز هویت و کنترل دسترسی

## نصب و راه‌اندازی

### 1. نصب وابستگی‌ها
```bash
pip install -r requirements.txt
```

### 2. ایجاد کاربر ادمین اولیه
برای اولین بار که برنامه را اجرا می‌کنید، باید یک کاربر ادمین بسازید:

```bash
python create_admin.py
```

یا با استفاده از متغیرهای محیطی:

```bash
# Windows (CMD)
set ADMIN_USERNAME=admin
set ADMIN_PASSWORD=your_secure_password
python create_admin.py

# Windows (PowerShell)
$env:ADMIN_USERNAME="admin"
$env:ADMIN_PASSWORD="your_secure_password"
python create_admin.py

# Linux/Mac
export ADMIN_USERNAME=admin
export ADMIN_PASSWORD=your_secure_password
python create_admin.py
```

### 3. اجرای برنامه
```bash
python cutting_web_app.py
```

سپس به آدرس `http://localhost:5000` بروید و با اطلاعات ادمین وارد شوید.

---

## سطوح دسترسی (نقش‌ها)

### 1. **Admin (مدیر)**
- **دسترسی‌ها**:
  - مدیریت کاربران (ایجاد، ویرایش، حذف، تغییر نقش)
  - حذف پروژه‌ها
  - مدیریت بکاپ (ایجاد، بازگردانی، حذف، دانلود)
  - تنظیمات قیمت پایه
  - همه عملیات Staff

### 2. **Staff (کارمند)**
- **دسترسی‌ها**:
  - ایجاد و ویرایش پروژه‌ها
  - ایجاد، ویرایش و حذف درب‌ها
  - عملیات انبار (افزودن/کسر موجودی، مدیریت شاخه‌ها)
  - محاسبات برش
  - قیمت‌گذاری
  - مشاهده همه صفحات

### 3. **Read Only (فقط مشاهده)**
- **دسترسی‌ها**:
  - فقط مشاهده پروژه‌ها، درب‌ها و گزارشات
  - بدون اجازه ایجاد، ویرایش یا حذف

---

## ویژگی‌های امنیتی

### 1. تغییر رمز اجباری در اولین ورود
- وقتی ادمین یک کاربر جدید می‌سازد، باید رمز موقت تعیین کند
- کاربر در اولین ورود **مجبور** به تغییر رمز عبور است
- تا زمانی که رمز تغییر نکند، به هیچ بخشی دسترسی ندارد

### 2. قفل خودکار حساب
- بعد از **5 تلاش ناموفق** برای ورود، حساب کاربر به مدت **15 دقیقه** قفل می‌شود
- پس از 15 دقیقه، کاربر می‌تواند دوباره تلاش کند

### 3. Hash کردن رمز عبور
- رمزهای عبور با الگوریتم `werkzeug.security` هش می‌شوند
- رمز خام هرگز در دیتابیس ذخیره نمی‌شود

### 4. Session امن
- از `Flask-Login` برای مدیریت session استفاده می‌شود
- `SECRET_KEY` را حتماً در `.env` تنظیم کنید:
  ```
  SECRET_KEY=your-very-long-and-random-secret-key-here
  ```

### 5. محافظت از routeها
- همه routeها نیاز به لاگین دارند (به جز `/auth/login`)
- routeهای حساس با decoratorهای `@admin_required` و `@staff_or_admin_required` محافظت شده‌اند

---

## مدیریت کاربران (توسط ادمین)

### ایجاد کاربر جدید
1. وارد پنل ادمین شوید: `/admin/users`
2. فرم "ایجاد کاربر جدید" را پر کنید:
   - نام کاربری
   - رمز عبور موقت
   - نقش (admin / staff / read_only)
3. روی "ایجاد کاربر" کلیک کنید
4. رمز موقت را به کاربر بدهید

### تغییر نقش کاربر
1. در لیست کاربران، روی "تغییر نقش" کلیک کنید
2. نقش جدید را انتخاب کنید
3. تایید کنید

### فعال/غیرفعال کردن کاربر
- روی دکمه "فعال/غیرفعال" کلیک کنید
- کاربران غیرفعال نمی‌توانند وارد سیستم شوند

### ریست رمز عبور
1. روی "ریست رمز" کلیک کنید
2. رمز جدید را وارد کنید
3. کاربر در ورود بعدی مجبور به تغییر رمز خواهد بود

---

## تغییر رمز عبور (توسط کاربر)

1. بعد از ورود، از منوی کاربری "تغییر رمز عبور" را انتخاب کنید
2. یا مستقیماً به `/auth/change_password` بروید
3. رمز فعلی، رمز جدید و تکرار آن را وارد کنید
4. رمز باید حداقل **6 کاراکتر** باشد

---

## ساختار فایل‌ها

```
.
├── auth_utils.py              # توابع احراز هویت و مدیریت کاربران
├── decorators.py              # Decoratorهای کنترل دسترسی
├── create_admin.py            # اسکریپت ساخت ادمین اولیه
├── db_migrations.py           # Migration جدول users (005)
├── cutting_web_app.py         # Flask app اصلی + گارد سراسری
├── routes/
│   ├── auth.py               # Login/Logout/Change Password
│   └── admin.py              # پنل مدیریت کاربران
└── templates/
    ├── login.html            # صفحه ورود
    ├── change_password.html  # صفحه تغییر رمز
    └── admin/
        └── users.html        # پنل مدیریت کاربران
```

---

## نکات امنیتی برای محیط Production

### 1. SECRET_KEY قوی
در فایل `.env`:
```
SECRET_KEY=a-very-long-random-string-at-least-32-characters-long
```

برای تولید SECRET_KEY تصادفی:
```python
import secrets
print(secrets.token_hex(32))
```

### 2. HTTPS
- حتماً برنامه را پشت **HTTPS** قرار دهید
- می‌توانید از Nginx یا Traefik استفاده کنید

### 3. تنظیمات Cookie
در `cutting_web_app.py`:
```python
app.config['SESSION_COOKIE_SECURE'] = True      # فقط HTTPS
app.config['SESSION_COOKIE_HTTPONLY'] = True    # جلوگیری از XSS
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'   # جلوگیری از CSRF
```

### 4. محدودیت تعداد درخواست (Rate Limiting)
برای جلوگیری از حملات Brute Force، می‌توانید از `Flask-Limiter` استفاده کنید:
```bash
pip install Flask-Limiter
```

### 5. بکاپ منظم
- از بخش "مدیریت بکاپ" به صورت منظم بکاپ بگیرید
- بکاپ‌ها را در مکان امن نگهداری کنید

---

## عیب‌یابی

### مشکل: نمی‌توانم وارد شوم
- بررسی کنید که `flask-login` نصب شده باشد
- مطمئن شوید که ادمین اولیه با `create_admin.py` ساخته شده
- اگر حساب قفل شده، 15 دقیقه صبر کنید یا از ادمین بخواهید حساب را فعال کند

### مشکل: خطای "must_change_password"
- این عادی است! کاربران جدید باید در اولین ورود رمز را تغییر دهند
- از صفحه تغییر رمز استفاده کنید

### مشکل: "شما به این بخش دسترسی ندارید"
- بررسی کنید نقش شما چیست (`/admin/users` - فقط admin)
- برخی بخش‌ها فقط برای admin یا staff هستند

---

## پشتیبانی

برای سوالات یا مشکلات، لطفاً با تیم فنی تماس بگیرید.
