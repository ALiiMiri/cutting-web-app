# ๐ ุณุณุชู ุฌููฺฏุฑ ุงุฒ ฺฉุณุฑ ูฺฉุฑุฑ ุงุฒ ุงูุจุงุฑ

## ูุดฺฉู ูุจู โ

ุฏุฑ ูุณุฎู ูุจูุ ูุฑ ฺูุฏ ุจุงุฑ ฺฉู ุฏฺฉูู "ฺฉุณุฑ ุงุฒ ุงูุจุงุฑ" ุฑุง ูโุฒุฏุฏุ ุงุฒ ุงูุจุงุฑ ฺฉุณุฑ ูโุดุฏ! ุงู ุนู:
- ฺฉ ูพุฑูฺู ูโุชููุณุช 10 ุจุงุฑ ฺฉุณุฑ ุจุดู
- ููุฌูุฏ ุงูุจุงุฑ ุงุดุชุจุงู ูโุดุฏ
- ูฺ ฺฉูุชุฑู ูุฌูุฏ ูุฏุงุดุช

## ุฑุงูโุญู ุฌุฏุฏ โ

ุญุงูุง ฺฉ ุณุณุชู ุฑุฏุงุจ ูพุงุฏูโุณุงุฒ ุดุฏู ฺฉู:

### 1๏ธโฃ ุฌุฏูู ุฌุฏุฏ: `inventory_deductions`

ุงู ุฌุฏูู ุชูุงู ฺฉุณุฑูุง ุงูุฌุงู ุดุฏู ุฑู ุซุจุช ูโฺฉูู:

| ุณุชูู | ุชูุถุญ |
|------|-------|
| `project_id` | ุดูุงุฑู ูพุฑูฺู |
| `profile_type_id` | ููุน ูพุฑููู |
| `quantity_deducted` | ุชุนุฏุงุฏ ฺฉุณุฑ ุดุฏู |
| `deduction_date` | ุชุงุฑุฎ ู ุฒูุงู ฺฉุณุฑ |

**ููู:** ฺฉ ูุฏ ฺฉุชุง (UNIQUE constraint) ุฑู `(project_id, profile_type_id)` ูุฌูุฏ ุฏุงุฑู ฺฉู ุฌูู ฺฉุณุฑ ูฺฉุฑุฑ ุฑู ูโฺฏุฑู.

### 2๏ธโฃ ฺฺฉ ุฎูุฏฺฉุงุฑ ูุจู ุงุฒ ฺฉุณุฑ

ูุจู ุงุฒ ุงูฺฉู ุงุฒ ุงูุจุงุฑ ฺุฒ ฺฉุณุฑ ุจุดูุ ุณุณุชู:

1. **ุจุฑุฑุณ ูโฺฉูู** ุขุง ุงู ูพุฑูฺู ูุจูุงู ฺฉุณุฑ ุดุฏูุ
2. ุงฺฏู **ูุจูุงู ฺฉุณุฑ ุดุฏู ุจุงุดู**:
   - ูพุงู ุฎุทุง ูุดูู ูโุฏู โ๏ธ
   - ุฌุฒุฆุงุช ฺฉุณุฑ ูุจู ุฑู ููุงุด ูโุฏู
   - **ูฺ ฺุฒ ุงุฒ ุงูุจุงุฑ ฺฉุณุฑ ููุดู**

3. ุงฺฏู **ูููุฒ ฺฉุณุฑ ูุดุฏู ุจุงุดู**:
   - ุงุฒ ุงูุจุงุฑ ฺฉุณุฑ ูโฺฉูู โ
   - ุฏุฑ ุฌุฏูู `inventory_deductions` ุซุจุช ูโฺฉูู
   - ูพุงู ููููุช ูุดูู ูโุฏู

### 3๏ธโฃ ูุซุงู ฺฉุงุฑุจุฑุฏ

#### ุญุงูุช 1: ุงููู ุจุงุฑ ฺฉุณุฑ ูโุฒูุฏ
```
ูพุฑูฺู: ุขูุง ุงุญูุฏ
ูพุฑููู: ูุฑู ูุณ ูุฏู
ูุงุฒ: 5 ุดุงุฎู

โ ููููุช! 5 ุดุงุฎู ุงุฒ ุงูุจุงุฑ ฺฉุณุฑ ุดุฏ
```

#### ุญุงูุช 2: ุฏูุจุงุฑู ุฏฺฉูู ฺฉุณุฑ ุฑู ูโุฒูุฏ
```
โ๏ธ ุงู ูพุฑูฺู ูุจูุงู ุงุฒ ุงูุจุงุฑ ฺฉุณุฑ ุดุฏู ุงุณุช!

ุฌุฒุฆุงุช ฺฉุณุฑูุง ูุจู:
โข ูุฑู ูุณ ูุฏู: 5 ุดุงุฎู ุฏุฑ ุชุงุฑุฎ 2025-01-15 14:30:22

โ ฺฉุณุฑ ุงูุฌุงู ูุดุฏ
```

## ุชุบุฑุงุช ุฏุฑ ฺฉุฏ

### ุชุงุจุน `remove_inventory_stock` (ุฏุฑ `database.py`)

```python
# ฺฺฉ ูโฺฉูู ุขุง ูุจูุงู ฺฉุณุฑ ุดุฏูุ
if project_id:
    cursor.execute(
        "SELECT quantity_deducted FROM inventory_deductions WHERE project_id = ? AND profile_type_id = ?",
        (project_id, profile_id)
    )
    existing_deduction = cursor.fetchone()
    if existing_deduction:
        return False, f"ุงู ูพุฑููู ูุจูุงู ุจุฑุง ุงู ูพุฑูฺู ฺฉุณุฑ ุดุฏู ุงุณุช"

# ุงฺฏู ุงูฺฉ ุจูุฏุ ุจุนุฏ ุงุฒ ฺฉุณุฑุ ุฏุฑ ุฌุฏูู ุซุจุช ูโฺฉูู
if project_id:
    cursor.execute(
        "INSERT INTO inventory_deductions (project_id, profile_type_id, quantity_deducted) VALUES (?, ?, ?)",
        (project_id, profile_id, quantity)
    )
```

### ุชุงุจุน `apply_cutting_plan` (ุฏุฑ `cutting_web_app.py`)

```python
# ูุจู ุงุฒ ูุฑ ฺฉุงุฑุ ฺฺฉ ูโฺฉูู
if check_if_already_deducted(project_id):
    existing_deductions = get_project_deductions(project_id)
    # ููุงุด ูพุงู ุฎุทุง ุจุง ุฌุฒุฆุงุช
    flash("ุงู ูพุฑูฺู ูุจูุงู ฺฉุณุฑ ุดุฏู ุงุณุช!", "warning")
    return redirect(...)
```

## ุชูุงุจุน ุฌุฏุฏ

### `get_project_deductions(project_id)`
ูุณุช ุชูุงู ฺฉุณุฑูุง ฺฉ ูพุฑูฺู ุฑู ุจุฑูโฺฏุฑุฏููู

### `check_if_already_deducted(project_id, profile_id=None)`
ฺฺฉ ูโฺฉูู ุขุง ูพุฑูฺู (ุง ูพุฑููู ุฎุงุต) ูุจูุงู ฺฉุณุฑ ุดุฏู ุง ูู

## ุชุณุช ุณุณุชู

ุจุฑุง ุชุณุช:

1. ฺฉ ูพุฑูฺู ุงุฌุงุฏ ฺฉูุฏ
2. ูุญุงุณุจู ุจุฑุด ุฑู ุงูุฌุงู ุจุฏุฏ
3. ุฏฺฉูู "ฺฉุณุฑ ุงุฒ ุงูุจุงุฑ" ุฑู ุจุฒูุฏ โ โ ููููุช
4. **ุฏูุจุงุฑู** ุฏฺฉูู "ฺฉุณุฑ ุงุฒ ุงูุจุงุฑ" ุฑู ุจุฒูุฏ โ โ๏ธ ูพุงู ุฎุทุง

ุง ูโุชููุฏ ุงุณฺฉุฑูพุช ุชุณุช ุฑู ุงุฌุฑุง ฺฉูุฏ:

```bash
python check_db.py
```

## ูฺฉุงุช ููู

- โ ุณุณุชู ุฏุฑ ุณุทุญ ุฏุชุงุจุณ ฺฉูุชุฑู ูโุดู (ูู ููุท Session)
- โ ุญุช ุงฺฏู Session ูพุงฺฉ ุจุดูุ ุจุงุฒ ูู ฺฉุงุฑ ูโฺฉูู
- โ ุงฺฏู ฺฉุงุฑุจุฑ ุตูุญู ุฑู ุฑูุฑุด ฺฉููุ ุจุงุฒ ูู ฺฉุงุฑ ูโฺฉูู
- โ ูุฏ ฺฉุชุง ุฏุฑ ุฏุชุงุจุณ ุฌูู ูุฑ ฺฏููู ฺฉุณุฑ ูฺฉุฑุฑ ุฑู ูโฺฏุฑู

## Migration ุฎูุฏฺฉุงุฑ

ุฌุฏูู ุฌุฏุฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ููุช ุจุฑูุงูู ุงุฌุฑุง ูุดู ุณุงุฎุชู ูโุดู (ุฏุฑ ุชุงุจุน `initialize_inventory_tables`).

ุฏุชุงุจุณโูุง ูุฏู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุขูพุฏุช ูุดู! ๐

